<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar Pedido | Los Gustitos de Vicky's</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .pedido-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 3%;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }

        .productos-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(49, 47, 47, 0.1);
        }

        .productos-section h2 {
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2rem;
            color: var(--graphite);
        }

        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .producto-card {
            background: var(--parchment);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--borde);
            transition: all 0.3s;
            cursor: pointer;
        }

        .producto-card:hover {
            border-color: var(--primario);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(235, 148, 134, 0.2);
        }

        .producto-card.selected {
            border-color: var(--primario);
            background: rgba(235, 148, 134, 0.1);
        }

        .producto-img {
            height: 150px;
            background-size: cover;
            background-position: center;
        }

        .producto-info {
            padding: 15px;
        }

        .producto-info h4 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: var(--graphite);
        }

        .producto-precio {
            color: var(--primario);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        /* Controles para selecci√≥n de paquetes */
        .bundle-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .coming-soon {
            display: inline-block;
            background: var(--thistle);
            color: white;
            padding: 6px 10px;
            border-radius: 20px;
            font-weight: 700;
        }

        .bundle-controls label {
            font-size: 0.9rem;
            color: var(--graphite);
        }

        .bundle-select, .packages-input {
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid var(--borde);
            font-size: 0.95rem;
            background: white;
            width: 100%;
            box-sizing: border-box;
        }

        .packages-input { text-align: center; }

        .small-note { font-size: 0.85rem; color: var(--texto-claro); }

        .bundle-controls .error-mensaje { margin-top: 6px; }

        /* Estilo visual para el select de paquetes acorde al theme
           Usamos fondo blanco para asegurar legibilidad del texto y
           aplicamos un peque√±o borde y sombra con los colores del sitio. */
        .bundle-select {
            appearance: none;
            -webkit-appearance: none;
            background: #ffffff;
            color: var(--graphite);
            padding: 10px 12px;
            border-radius: 12px;
            border: 2px solid var(--borde);
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(235,148,134,0.08);
            width: 100%;
        }

        .bundle-select:focus {
            outline: 3px solid rgba(235,148,134,0.12);
        }

        /* Agregar un indicador visual de select (flecha) en navegadores que lo soporten */
        .bundle-select { background-image: linear-gradient(45deg, transparent 50%, var(--borde) 50%), linear-gradient(135deg, var(--borde) 50%, transparent 50%); background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px); background-size: 5px 5px, 5px 5px; background-repeat: no-repeat; }

        .error-mensaje {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .error-mensaje.show {
            display: block;
        }

        .recibo-section {
            position: sticky;
            top: 120px;
            /* Limitar la altura de la secci√≥n de recibo para que su contenido pueda hacer scroll
               sin empujar la columna de productos. */
            max-height: calc(100vh - 140px);
            overflow: hidden;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(49, 47, 47, 0.1);
        }

        .recibo-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8rem;
            color: var(--graphite);
        }

        .recibo-content {
            border: 2px solid var(--borde);
            border-radius: 15px;
            padding: 20px;
            background: var(--parchment);
            /* Hacer que el contenido del recibo pueda hacer scroll interno si es muy largo */
            max-height: calc(100vh - 240px);
            overflow-y: auto;
        }

        .recibo-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--borde);
        }

        .recibo-header h3 {
            margin: 0;
            color: var(--graphite);
            font-size: 1.5rem;
        }

        .recibo-items {
            margin-bottom: 20px;
            /* Dejar que sea el contenedor .recibo-content quien gestione el scroll principal.
               Aqu√≠ no limitamos demasiado la altura para evitar dobles scroll inc√≥modos. */
            overflow-y: visible;
        }

        .recibo-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--borde);
        }

        .recibo-item:last-child {
            border-bottom: none;
        }

        .recibo-item-nombre {
            flex: 1;
            color: var(--texto);
        }

        .recibo-item-cantidad {
            margin: 0 15px;
            color: var(--texto-claro);
        }

        .recibo-item-precio {
            font-weight: bold;
            color: var(--graphite);
            min-width: 100px;
            text-align: right;
        }

        .recibo-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 3px solid var(--primario);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recibo-total-label {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--graphite);
        }

        .recibo-total-monto {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primario);
        }

        .recibo-vacio {
            text-align: center;
            padding: 40px 20px;
            color: var(--texto-claro);
        }

        .btn-finalizar {
            width: 100%;
            background: var(--primario);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 6px 20px rgba(235, 148, 134, 0.4);
        }

        .btn-finalizar:hover:not(:disabled) {
            background: var(--dusty-olive);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(100, 111, 88, 0.5);
        }

        .btn-finalizar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .categoria-pedido {
            margin-bottom: 40px;
        }

        .categoria-pedido h3 {
            color: var(--graphite);
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--thistle);
        }

        @media (max-width: 1024px) {
            .pedido-container {
                grid-template-columns: 1fr;
            }

            .recibo-section {
                position: relative;
                top: 0;
            }
        }

        @media (max-width: 768px) {
            .productos-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        /* Mejoras para pantallas m√≥viles peque√±as */
        @media (max-width: 480px) {
            .productos-grid { grid-template-columns: 1fr; gap: 12px; }
            .producto-card { display: flex; gap: 12px; align-items: stretch; }
            .producto-img { width: 40%; min-height: 110px; height: auto; background-size: cover; }
            .producto-info { padding: 10px; width: 60%; }
            .producto-info h4 { font-size: 0.95rem; }
            .bundle-controls { gap: 6px; }
            .bundle-select, .packages-input { font-size: 0.95rem; }
            .packages-input { width: 60%; margin: 0 auto; }
        }

        #recibo-imagen {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <a href="index.html">
                <img src="img/logo.jpg" alt="Los Gustitos de Vicky's">
            </a>
        </div>
        <nav>
            <a href="index.html">Inicio</a>
            <a href="menu.html">Ver Men√∫</a>
            <a href="servicios.html">Servicios</a>
            <a href="https://wa.me/51933056666" class="btn-cta" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
        </nav>
    </header>

    <section class="hero">
        <h1>Realizar Pedido</h1>
        <p style="font-size: 1.3rem; color: white; margin-top: 10px;">Selecciona tus productos (m√≠nimo 20 unidades por producto)</p>
    </section>

    <main>
        <div class="pedido-container">
            <div class="productos-section">
                <h2><i class="fas fa-utensils"></i> Selecciona tus productos</h2>
                
                <!-- Productos se cargar√°n aqu√≠ din√°micamente -->
                <div id="productos-container"></div>
            </div>

            <div class="recibo-section">
                <h2><i class="fas fa-receipt"></i> Resumen del Pedido</h2>
                <div class="recibo-content" id="recibo-content">
                    <div class="recibo-vacio">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; color: var(--thistle); margin-bottom: 15px;"></i>
                        <p>Selecciona productos para ver el resumen</p>
                    </div>
                </div>
                <button class="btn-finalizar" id="btn-finalizar" disabled>
                    <i class="fab fa-whatsapp"></i> Enviar Pedido por WhatsApp
                </button>
            </div>
        </div>
    </main>

    <div id="recibo-imagen"></div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3><i class="fas fa-clock"></i> Tiempo de Anticipaci√≥n</h3>
                <p>¬øCon cu√°nto tiempo pedir?</p>
                <p><strong>M√≠nimo 72 horas de anticipaci√≥n</strong> para garantizar la mejor calidad en tu evento.</p>
            </div>
            
            <div class="footer-section">
                <h3><i class="fas fa-map-marker-alt"></i> Zonas de Reparto</h3>
                <p>Llevamos nuestros sabores a toda Arequipa:</p>
                <ul>
                    <li><i class="fas fa-check"></i> Centro Hist√≥rico</li>
                    <li><i class="fas fa-check"></i> Yanahuara</li>
                    <li><i class="fas fa-check"></i> Cayma</li>
                    <li><i class="fas fa-check"></i> Sachaca</li>
                    <li><i class="fas fa-check"></i> Y otros distritos</li>
                </ul>
                <p><em>Consulta disponibilidad para tu zona</em></p>
            </div>
            
            <div class="footer-section">
                <h3><i class="fas fa-money-bill-wave"></i> Formas de Pago</h3>
                <p>Aceptamos m√∫ltiples formas de pago:</p>
                <ul>
                    <li><i class="fab fa-whatsapp"></i> Yape</li>
                    <li><i class="fab fa-whatsapp"></i> Plin</li>
                    <li><i class="fas fa-university"></i> Transferencia Bancaria</li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3><i class="fab fa-whatsapp"></i> Cont√°ctanos</h3>
                <p>¬øTienes dudas o quieres personalizar tu pedido?</p>
                <a href="https://wa.me/51933056666?text=Hola!%20Quiero%20m√°s%20informaci√≥n" class="whatsapp-btn" target="_blank">
                    <i class="fab fa-whatsapp"></i> Escr√≠benos por WhatsApp
                </a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2026 Los Gustitos de Vicky's. Calidad hecha con amor.</p>
        </div>
    </footer>

    <script>
        // Base de datos de productos con precios por paquete (valores en soles)
        // Notas: bocaditos y similares se venden a partir de 20 unidades (tama√±os: 20/50/100)
        // Platos de Fondo y Zona Kids: tama√±os t√≠picos 10/50 (se agrega 20 estimado = 10*2 - 35)
        const productos = [
            // Para Empezar (bocaditos)
            { id: 1, nombre: 'Ceviche en Conchitas', imagen: 'imagenes/bocaditos/ceviche-conchitas.jpg', bundles: {20:95, 50:180, 100:350}, categoria: 'Para Empezar', minUnits: 20 },
            { id: 2, nombre: 'Choritos a la Chalaca', imagen: 'imagenes/bocaditos/choritos.jpg', bundles: {20:90, 50:170, 100:330}, categoria: 'Para Empezar', minUnits: 20 },
            { id: 3, nombre: 'Mini Causitas de Pollo', imagen: 'imagenes/bocaditos/mini-causa-pollo.jpg', bundles: {20:85, 50:160, 100:310}, categoria: 'Para Empezar', minUnits: 20 },
            { id: 4, nombre: 'Mini Causitas de At√∫n', imagen: 'imagenes/bocaditos/mini-causa-atun.png', bundles: {20:75, 50:145, 100:280}, categoria: 'Para Empezar', minUnits: 20 },

            // Calentitos y Crujientes
            { id: 5, nombre: 'Teque√±os', imagen: 'imagenes/bocaditos/teque√±os.jpg', bundles: {20:70, 50:130, 100:260}, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 6, nombre: 'Want√°n Frito', imagen: 'imagenes/bocaditos/wantanes.jpeg', bundles: {20:75, 50:145, 100:300}, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 7, nombre: 'Brochetas de Pollo', imagen: 'imagenes/bocaditos/brochetas.jpg', bundles: {20:100, 50:190, 100:370}, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 8, nombre: 'Muslitos de Pollo', imagen: 'imagenes/bocaditos/muslitos-pollo.jpg', bundles: {20:90, 50:175, 100:340}, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 9, nombre: 'Canastitas de Pollo', imagen: 'imagenes/bocaditos/canastitas-polllo.avif', bundles: null, comingSoon: true, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 10, nombre: 'Mini Tamalitos', imagen: 'imagenes/bocaditos/minitamalitos.jpeg', bundles: {20:100, 50:190, 100:370}, categoria: 'Calentitos y Crujientes', minUnits: 20 },

            // Los Sanguchitos
            { id: 11, nombre: 'Petipanes con Pollo Deshilachado', imagen: 'imagenes/bocaditos/petipan.jpg', bundles: {50:90}, categoria: 'Los Sanguchitos', minUnits: 50 },
            { id: 12, nombre: 'Hamburguesitas Caseras', imagen: 'imagenes/bocaditos/hamburguesitas.jpg', bundles: {20:80, 50:150, 100:300}, categoria: 'Los Sanguchitos', minUnits: 20 },
            { id: 13, nombre: 'Mini Triples Cl√°sicos', imagen: 'imagenes/bocaditos/minitriples.jpg', bundles: null, comingSoon: true, categoria: 'Los Sanguchitos', minUnits: 20 },
            { id: 14, nombre: 'Mini Triples Especial', imagen: 'imagenes/bocaditos/mini-triples.jpg', bundles: null, comingSoon: true, categoria: 'Los Sanguchitos', minUnits: 20 },

            // Platos de Fondo (tama√±os 10 / 20 (estimado) / 50)
            // 20 = 10*2 - 35 (estimaci√≥n solicitada)
            { id: 15, nombre: 'Asado con Pur√©', imagen: 'imagenes/platos/asado-pure.jpeg', bundles: {10:180, 20: (180*2 - 35), 50:830}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 16, nombre: 'Aj√≠ de Gallina', imagen: 'imagenes/platos/aji-gallina.jpg', bundles: {10:100, 20: (100*2 - 35), 50:460}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 17, nombre: 'Chancho al Horno', imagen: 'imagenes/platos/chancho-horno.avif', bundles: {10:200, 20: (200*2 - 35), 50:950}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 18, nombre: 'Pollo al Horno', imagen: 'imagenes/platos/pollo-horno.jpg', bundles: {10:160, 20: (160*2 - 35), 50:760}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 19, nombre: 'Chuleta Completa', imagen: 'imagenes/platos/chuleta-completo.jpg', bundles: {10:190, 20: (190*2 - 35), 50:920}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 20, nombre: 'Pastel de Papa Premium', imagen: 'imagenes/platos/pastel-papa-premium.png', bundles: {10:200, 20: (200*2 - 35), 50:950}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 21, nombre: 'Pastel de Tallar√≠n Premium', imagen: 'imagenes/platos/pastel-tallarin-milanesa.png', bundles: {10:200, 20: (200*2 - 35), 50:950}, categoria: 'Platos de Fondo', minUnits: 10 },

            // Zona Kids (tama√±os 10 / 20 estimado / 50)
            { id: 22, nombre: 'Milanesa de Pollo', imagen: 'imagenes/platos/milanesa-pollo.jpg', bundles: {10:110, 20: (110*2 - 35), 50:500}, categoria: 'Zona Kids', minUnits: 10 },
            { id: 23, nombre: 'Chicharr√≥n de Pollo', imagen: 'imagenes/platos/chicharron-pollo.jpg', bundles: {10:110, 20: (110*2 - 35), 50:500}, categoria: 'Zona Kids', minUnits: 10 },
            { id: 24, nombre: 'Arroz Chaufa', imagen: 'imagenes/platos/chaufa.avif', bundles: {10:95, 20: (95*2 - 35), 50:450}, categoria: 'Zona Kids', minUnits: 10 }
        ];

        // Estado del pedido
        const pedido = {};
        const DISCOUNT_PERCENT = 0.05; // 5% descuento al seleccionar 50 unidades (Platos / Kids)

        // Renderizar productos (ahora con selecci√≥n de paquetes o elecci√≥n por unidades)
        function renderizarProductos() {
            const container = document.getElementById('productos-container');
            container.innerHTML = '';
            const categorias = [...new Set(productos.map(p => p.categoria))];

            categorias.forEach(categoria => {
                const categoriaDiv = document.createElement('div');
                categoriaDiv.className = 'categoria-pedido';
                categoriaDiv.innerHTML = `<h3>${categoria}</h3><div class="productos-grid"></div>`;

                const grid = categoriaDiv.querySelector('.productos-grid');
                const productosCategoria = productos.filter(p => p.categoria === categoria);

                productosCategoria.forEach(producto => {
                    const card = document.createElement('div');
                    card.className = 'producto-card';
                    card.dataset.productoId = producto.id;

                    const minUnits = producto.minUnits || 20;

                    // Si el producto est√° marcado como pr√≥ximamente (comingSoon) o no tiene bundles
                    if (producto.comingSoon || !producto.bundles) {
                        card.innerHTML = `
                            <div class="producto-img" style="background-image: url('${producto.imagen}')"></div>
                            <div class="producto-info">
                                <h4>${producto.nombre}</h4>
                                <div class="bundle-controls">
                                    <div class="coming-soon">Pronto</div>
                                    <div class="small-note">Disponibilidad y precio pr√≥ximamente</div>
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                        return;
                    }
                    // Si el producto tiene minUnits >= 20 lo tratamos como bocadito (select con paquetes)
                    if ((producto.minUnits || 20) >= 20) {
                        const bundleSizes = Object.keys(producto.bundles).map(n => parseInt(n)).sort((a,b)=>a-b);
                        let optionsHtml = '<option value="">Seleccionar paquete</option>';
                        bundleSizes.forEach(size => {
                            const price = producto.bundles[size];
                            optionsHtml += `<option value="${size}">${size} unidades ‚Äî S/ ${Number(price).toFixed(2)}</option>`;
                        });

                        card.innerHTML = `
                            <div class="producto-img" style="background-image: url('${producto.imagen}')"></div>
                            <div class="producto-info">
                                <h4>${producto.nombre}</h4>
                                <div class="bundle-controls">
                                    <label>Paquete:</label>
                                    <select class="bundle-select" data-producto-id="${producto.id}">${optionsHtml}</select>
                                    <div class="small-note">M√≠nimo ${minUnits} unidades por producto</div>
                                    <div class="error-mensaje">Cantidad m√≠nima no alcanzada</div>
                                </div>
                            </div>
                        `;

                        grid.appendChild(card);
                    } else {
                        // Platos de Fondo / Zona Kids: permitir elegir 10/20/30/40/50 y "sugerir otra cantidad" (>=10)
                        const pricePer10 = Number(producto.bundles[10]);
                        card.innerHTML = `
                            <div class="producto-img" style="background-image: url('${producto.imagen}')"></div>
                            <div class="producto-info">
                                <h4>${producto.nombre}</h4>
                                <div class="bundle-controls">
                                    <label>Elige cantidad:</label>
                                    <div class="qty-options" data-producto-id="${producto.id}" style="margin-top:6px;">
                                        <label><input type="radio" name="qty-${producto.id}" value="10"> 10</label>
                                        <label style="margin-left:8px;"><input type="radio" name="qty-${producto.id}" value="20"> 20</label>
                                        <label style="margin-left:8px;"><input type="radio" name="qty-${producto.id}" value="30"> 30</label>
                                        <label style="margin-left:8px;"><input type="radio" name="qty-${producto.id}" value="40"> 40</label>
                                        <label style="margin-left:8px;"><input type="radio" name="qty-${producto.id}" value="50"> 50</label>
                                        <label style="margin-left:8px;"><input type="radio" name="qty-${producto.id}" value="other"> Sugerir otra cantidad</label>
                                    </div>
                                    <input type="number" min="10" class="custom-qty" placeholder="Indica cantidad (>=10)" style="width:140px; margin-top:6px; display:none;">
                                    <div class="small-note" style="margin-top:6px;">Precio base por 10 unidades: S/ ${pricePer10.toFixed(2)}</div>
                                    <div class="error-mensaje">Cantidad m√≠nima no alcanzada</div>
                                </div>
                            </div>
                        `;

                        grid.appendChild(card);
                    }
                });

                container.appendChild(categoriaDiv);
            });

            // Listener para selects (selecci√≥n de paquete implica 1 paquete)
            document.querySelectorAll('.bundle-select').forEach(sel => sel.addEventListener('change', manejarCambioPaquete));

            // Listeners para selecciones por unidades (Platos / Zona Kids)
            document.querySelectorAll('.qty-options').forEach(div => {
                const pid = parseInt(div.dataset.productoId);
                const radios = div.querySelectorAll(`input[name="qty-${pid}"]`);
                radios.forEach(r => r.addEventListener('change', () => manejarCambioCantidad(pid)));
                // custom input
                const card = document.querySelector(`.producto-card[data-producto-id="${pid}"]`);
                if (card) {
                    const custom = card.querySelector('.custom-qty');
                    if (custom) custom.addEventListener('input', () => manejarCambioCantidad(pid));
                }
            });
        }

        // Manejar cambios en cantidad para Platos / Zona Kids
        function manejarCambioCantidad(productoId) {
            const producto = productos.find(p => p.id === productoId);
            const card = document.querySelector(`.producto-card[data-producto-id="${productoId}"]`);
            if (!card) return;

            const radios = card.querySelectorAll(`input[name="qty-${productoId}"]`);
            const customInput = card.querySelector('.custom-qty');
            const errorMensaje = card.querySelector('.error-mensaje');

            let selected = Array.from(radios).find(r => r.checked);
            // si el usuario escribi√≥ en el input personalizado sin marcar 'other', lo activamos
            if (!selected && customInput && customInput.value) {
                const otherRadio = Array.from(radios).find(r => r.value === 'other');
                if (otherRadio) {
                    otherRadio.checked = true;
                    selected = otherRadio;
                }
            }
            if (!selected) {
                // nothing selected -> remove
                delete pedido[productoId];
                card.classList.remove('selected');
                errorMensaje.classList.remove('show');
                if (customInput) customInput.style.display = 'none';
                actualizarRecibo();
                return;
            }

            // mostrar/ocultar campo personalizado
            if (customInput) customInput.style.display = (selected.value === 'other') ? 'inline-block' : 'none';

            let qty;
            if (selected.value === 'other') {
                qty = parseInt(customInput ? customInput.value : NaN, 10);
            } else {
                qty = parseInt(selected.value, 10);
            }

            if (isNaN(qty) || qty < (producto.minUnits || 10)) {
                errorMensaje.classList.add('show');
                delete pedido[productoId];
                card.classList.remove('selected');
                actualizarRecibo();
                return;
            }

            errorMensaje.classList.remove('show');

            // Price logic: base price is bundles[10]
            const pricePer10 = Number(producto.bundles[10]);
            const multiplier = qty / 10;
            let subtotal = pricePer10 * multiplier;

            // Aplicar descuento peque√±o si qty == 50
            if (qty === 50) subtotal = subtotal * (1 - DISCOUNT_PERCENT);

            pedido[productoId] = { type: 'units', qty, pricePer10, subtotal, totalUnits: qty };
            card.classList.add('selected');
            actualizarRecibo();
        }

        // Manejar cambios en paquetes (select o n√∫mero de paquetes)
        function manejarCambioPaquete(e) {
            const productoId = parseInt(e.target.dataset.productoId);
            const card = document.querySelector(`.producto-card[data-producto-id="${productoId}"]`);

            const select = card.querySelector('.bundle-select');
            const errorMensaje = card.querySelector('.error-mensaje');
            const bundleSize = parseInt(select.value);

            const producto = productos.find(p => p.id === productoId);
            // cuando no hay selecci√≥n (value === "") eliminar del pedido
            if (!bundleSize) {
                delete pedido[productoId];
                card.classList.remove('selected');
                errorMensaje.classList.remove('show');
                actualizarRecibo();
                return;
            }

            const bundlePrice = Number(producto.bundles[bundleSize]);
            // ahora cada selecci√≥n corresponde a un paquete (cantidad = 1)
            const packages = 1;
            const totalUnits = bundleSize * packages;

            const minUnits = producto.minUnits || 20;

            if (totalUnits < minUnits) {
                errorMensaje.classList.add('show');
                delete pedido[productoId];
                card.classList.remove('selected');
            } else {
                errorMensaje.classList.remove('show');
                pedido[productoId] = { bundleSize, packages, bundlePrice, totalUnits };
                card.classList.add('selected');
            }

            actualizarRecibo();
        }

        // Actualizar recibo
        function actualizarRecibo() {
            const reciboContent = document.getElementById('recibo-content');
            const btnFinalizar = document.getElementById('btn-finalizar');
            const items = Object.keys(pedido);

            if (items.length === 0) {
                reciboContent.innerHTML = `
                    <div class="recibo-vacio">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; color: var(--thistle); margin-bottom: 15px;"></i>
                        <p>Selecciona productos para ver el resumen</p>
                    </div>
                `;
                btnFinalizar.disabled = true;
                return;
            }

            let total = 0;
            const fecha = new Date();
            const fechaFormateada = fecha.toLocaleDateString('es-PE', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let html = `
                <div class="recibo-header">
                    <h3>Los Gustitos de Vicky's</h3>
                    <p style="margin: 5px 0; color: var(--texto-claro); font-size: 0.9rem;">Pedido #${Date.now().toString().slice(-6)}</p>
                    <p style="margin: 5px 0; color: var(--texto-claro); font-size: 0.85rem;">${fechaFormateada}</p>
                </div>
                <div class="recibo-items">
            `;

            items.forEach(productoId => {
                const producto = productos.find(p => p.id === parseInt(productoId));
                const entry = pedido[productoId];
                let subtotal = 0;

                if (entry.type === 'units') {
                    subtotal = Number(entry.subtotal || entry.pricePer10 * (entry.qty / 10));
                    total += subtotal;

                    html += `
                        <div class="recibo-item">
                            <div class="recibo-item-nombre">
                                ${producto.nombre}<br>
                                <small style="color: var(--texto-claro); font-size: 0.85rem;">${entry.qty} unidades ‚Äî S/ ${entry.pricePer10.toFixed(2)} por 10 u. ${entry.qty===50? '(incluye descuento)':''}</small>
                            </div>
                            <div class="recibo-item-cantidad">${entry.qty} u.</div>
                            <div class="recibo-item-precio">S/ ${subtotal.toFixed(2)}</div>
                            <div style="margin-left:12px;"><button class="remove-item" data-producto-id="${producto.id}" style="background:transparent;border:1px solid var(--borde);padding:6px 10px;border-radius:8px;cursor:pointer;color:var(--graphite);">Quitar</button></div>
                        </div>
                    `;
                } else {
                    // paquete (bocaditos u otros)
                    subtotal = entry.bundlePrice * entry.packages;
                    total += subtotal;

                    html += `
                        <div class="recibo-item">
                            <div class="recibo-item-nombre">
                                ${producto.nombre}<br>
                                <small style="color: var(--texto-claro); font-size: 0.85rem;">${entry.packages} x ${entry.bundleSize} unidades ‚Äî S/ ${entry.bundlePrice.toFixed(2)} por paquete</small>
                            </div>
                            <div class="recibo-item-cantidad">${entry.totalUnits} u.</div>
                            <div class="recibo-item-precio">S/ ${subtotal.toFixed(2)}</div>
                            <div style="margin-left:12px;"><button class="remove-item" data-producto-id="${producto.id}" style="background:transparent;border:1px solid var(--borde);padding:6px 10px;border-radius:8px;cursor:pointer;color:var(--graphite);">Quitar</button></div>
                        </div>
                    `;
                }
            });

            html += `
                </div>
                <div class="recibo-total">
                    <div class="recibo-total-label">Total:</div>
                    <div class="recibo-total-monto">S/ ${total.toFixed(2)}</div>
                </div>
            `;

            reciboContent.innerHTML = html;
                // Adjuntar listeners a botones Quitar
                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.addEventListener('click', (ev) => {
                        const id = parseInt(ev.currentTarget.dataset.productoId);
                        // remover del pedido y resetear controles
                        delete pedido[id];
                        const card = document.querySelector(`.producto-card[data-producto-id="${id}"]`);
                        if (card) {
                            const sel = card.querySelector('.bundle-select');
                            if (sel) sel.value = '';
                            const radios = card.querySelectorAll(`input[name="qty-${id}"]`);
                            radios.forEach(r => r.checked = false);
                            const custom = card.querySelector('.custom-qty');
                            if (custom) custom.value = '';
                            card.classList.remove('selected');
                        }
                        actualizarRecibo();
                    });
                });
            btnFinalizar.disabled = false;
        }

        // Generar imagen del recibo y redirigir a WhatsApp
        async function finalizarPedido() {
            const btnFinalizar = document.getElementById('btn-finalizar');
            const reciboContent = document.getElementById('recibo-content');
            const reciboImagen = document.getElementById('recibo-imagen');
            
            // Deshabilitar bot√≥n y mostrar loading
            btnFinalizar.disabled = true;
            const textoOriginal = btnFinalizar.innerHTML;
            btnFinalizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando recibo...';
            
            // Crear una copia del recibo para la imagen con mejor formato
            reciboImagen.innerHTML = reciboContent.innerHTML;
            reciboImagen.style.display = 'block';
            reciboImagen.style.background = 'white';
            reciboImagen.style.padding = '40px';
            reciboImagen.style.maxWidth = '600px';
            reciboImagen.style.margin = '0 auto';
            reciboImagen.style.borderRadius = '20px';
            reciboImagen.style.boxShadow = '0 4px 15px rgba(49, 47, 47, 0.1)';
            reciboImagen.style.position = 'absolute';
            reciboImagen.style.left = '-9999px';

            try {
                // Esperar un momento para que se renderice
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Generar imagen usando html2canvas
                const canvas = await html2canvas(reciboImagen, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });

                // Convertir canvas a blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        throw new Error('Error al generar la imagen');
                    }
                    
                    // Crear URL temporal para la imagen
                    const imageUrl = URL.createObjectURL(blob);
                    
                    // Crear mensaje para WhatsApp con datos de productos (soportando packages y unidades)
                    const items = Object.keys(pedido);
                    let mensaje = '¬°Hola! üëã\n\n';
                    mensaje += 'Quiero realizar el siguiente pedido:\n\n';

                    let total = 0;
                    items.forEach(productoId => {
                        const producto = productos.find(p => p.id === parseInt(productoId));
                        const entry = pedido[productoId];
                        if (entry.type === 'units') {
                            const sub = Number(entry.subtotal || entry.pricePer10 * (entry.qty / 10));
                            total += sub;
                            mensaje += `‚Ä¢ ${producto.nombre}: ${entry.qty} unidades ‚Äî S/ ${sub.toFixed(2)}\n`;
                        } else {
                            const sub = entry.bundlePrice * entry.packages;
                            total += sub;
                            mensaje += `‚Ä¢ ${producto.nombre}: ${entry.totalUnits} unidades (${entry.packages} x ${entry.bundleSize}) ‚Äî S/ ${sub.toFixed(2)}\n`;
                        }
                    });

                    mensaje += `\nüí∞ Total: S/ ${total.toFixed(2)}\n\n`;
                    mensaje += 'üìé Adjunto el recibo del pedido en la siguiente imagen.';
                    
                    // Codificar mensaje para URL
                    const mensajeCodificado = encodeURIComponent(mensaje);
                    
                    // Crear enlace de WhatsApp
                    const whatsappUrl = `https://wa.me/51933056666?text=${mensajeCodificado}`;
                    
                    // Crear enlace de descarga para la imagen
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = `pedido-vickys-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Mostrar mensaje informativo
                    alert('‚úÖ Recibo descargado exitosamente.\n\nAhora se abrir√° WhatsApp. Por favor:\n1. Adjunta la imagen del recibo que se descarg√≥\n2. Env√≠a el mensaje');
                    
                    // Redirigir a WhatsApp despu√©s de un breve delay
                    setTimeout(() => {
                        window.open(whatsappUrl, '_blank');
                        
                        // Limpiar despu√©s de un momento
                        setTimeout(() => {
                            URL.revokeObjectURL(imageUrl);
                            reciboImagen.style.display = 'none';
                            reciboImagen.innerHTML = '';
                            reciboImagen.style.position = 'static';
                            btnFinalizar.innerHTML = textoOriginal;
                            btnFinalizar.disabled = false;
                        }, 2000);
                    }, 1000);
                }, 'image/png', 0.95);
            } catch (error) {
                console.error('Error al generar imagen:', error);
                alert('‚ùå Hubo un error al generar el recibo. Por favor, intenta nuevamente.');
                btnFinalizar.innerHTML = textoOriginal;
                btnFinalizar.disabled = false;
                reciboImagen.style.display = 'none';
                reciboImagen.innerHTML = '';
                reciboImagen.style.position = 'static';
            }
        }

        // Event listener para bot√≥n finalizar
        document.getElementById('btn-finalizar').addEventListener('click', finalizarPedido);

        // Inicializar
        renderizarProductos();
    </script>
</body>
</html>
