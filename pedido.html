<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar Pedido | Los Gustitos de Vicky's</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- mobile nav rules moved to style.css -->
    <style>
        .pedido-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 3%;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }

        .productos-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(49, 47, 47, 0.1);
        }

        .productos-section h2 {
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2rem;
            color: var(--graphite);
        }

        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .producto-card {
            background: var(--parchment);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--borde);
            transition: all 0.3s;
            cursor: pointer;
        }

        .producto-card:hover {
            border-color: var(--primario);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(235, 148, 134, 0.2);
        }

        .producto-card.selected {
            border-color: var(--primario);
            background: rgba(235, 148, 134, 0.1);
        }

        .producto-img {
            height: 150px;
            background-size: cover;
            background-position: center;
        }

        .producto-info {
            padding: 15px;
        }

        .producto-info h4 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: var(--graphite);
        }

        .producto-precio {
            color: var(--primario);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        /* Controles para selección de paquetes */
        .bundle-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .coming-soon {
            display: inline-block;
            background: var(--thistle);
            color: white;
            padding: 6px 10px;
            border-radius: 20px;
            font-weight: 700;
        }

        .bundle-controls label {
            font-size: 0.9rem;
            color: var(--graphite);
        }

        .bundle-select, .packages-input {
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid var(--borde);
            font-size: 0.95rem;
            background: white;
            width: 100%;
            box-sizing: border-box;
        }

        .packages-input { text-align: center; }

        .small-note { font-size: 0.85rem; color: var(--texto-claro); }

        .bundle-controls .error-mensaje { margin-top: 6px; }

        /* Animated select display (marquee-like) */
        .select-wrapper { position: relative; display: block; }
        .select-wrapper .bundle-select { position: relative; z-index: 1; }
        .select-display {
            position: absolute;
            left: 12px;
            right: 36px; /* dejar espacio para la flecha nativa */
            top: 50%;
            transform: translateY(-50%);
            overflow: hidden;
            pointer-events: none;
            white-space: nowrap;
            display: block;
            z-index: 3;
            font-size: 0.95rem;
            line-height: 1.2;
            color: var(--graphite);
            background: transparent;
        }

        /* Ocultar la capa overlay cuando el select está en foco (dropdown abierto) */
        .select-wrapper .bundle-select:focus + .select-display,
        .select-wrapper .bundle-select[aria-expanded="true"] + .select-display {
            display: none;
        }
        .select-display .marquee { display: inline-block; transform: translateX(0); }
        @keyframes scrollLR {
            from { transform: translateX(0); }
            to   { transform: translateX(calc(-1 * var(--shift, 0px))); }
        }
        .select-display.scrolling .marquee {
            animation-name: scrollLR;
            animation-duration: 6s;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
            animation-direction: alternate;
        }
        /* Hacer el select 'invisible' para que la capa overlay muestre el texto animado
           pero mantener la flecha y funcionalidad nativa. */
        /* Cuando el wrapper tiene la clase overlay-active, ocultamos el texto nativo
           del select y mostramos la capa animada. Al removerla (cuando se abre)
           el select nativo muestra el texto y el dropdown es visible normalmente. */
        .select-wrapper.overlay-active .bundle-select {
            background: transparent;
            color: transparent;
            z-index: 2;
            position: relative;
        }
        
        .select-wrapper.overlay-active .select-display { display: block; }
        .select-wrapper .select-display { display: none; }

        /* Estilo visual para el select de paquetes acorde al theme
           Usamos fondo blanco para asegurar legibilidad del texto y
           aplicamos un pequeño borde y sombra con los colores del sitio. */
        .bundle-select {
            appearance: none;
            -webkit-appearance: none;
            background: #ffffff;
            color: var(--graphite);
            padding: 10px 12px;
            border-radius: 12px;
            border: 2px solid var(--borde);
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(235,148,134,0.08);
            width: 100%;
        }

        .bundle-select:focus {
            outline: 3px solid rgba(235,148,134,0.12);
        }

        /* Agregar un indicador visual de select (flecha) en navegadores que lo soporten */
        .bundle-select { background-image: linear-gradient(45deg, transparent 50%, var(--borde) 50%), linear-gradient(135deg, var(--borde) 50%, transparent 50%); background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px); background-size: 5px 5px, 5px 5px; background-repeat: no-repeat; }

        .error-mensaje {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .error-mensaje.show {
            display: block;
        }

        .recibo-section {
            position: sticky;
            top: 120px;
            /* Limitar la altura de la sección de recibo para que su contenido pueda hacer scroll
               sin empujar la columna de productos. Usamos flex para mantener el botón siempre visible. */
            max-height: calc(100vh - 140px);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(49, 47, 47, 0.1);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recibo-section h2 {
            margin-top: 0;
            margin-bottom: 0;
            font-size: 1.8rem;
            color: var(--graphite);
        }

        .recibo-content {
            border: 2px solid var(--borde);
            border-radius: 15px;
            padding: 20px;
            background: var(--parchment);
            /* Hacer que el contenido del recibo haga scroll interno y el contenedor mantenga el botón visible */
            overflow-y: auto;
            flex: 1 1 auto;
        }

        .recibo-actions { display: block; }

        .recibo-section .btn-finalizar { margin-top: 6px; align-self: stretch; }

        .recibo-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--borde);
        }

        .recibo-header h3 {
            margin: 0;
            color: var(--graphite);
            font-size: 1.5rem;
        }

        .recibo-items {
            margin-bottom: 20px;
            /* Dejar que sea el contenedor .recibo-content quien gestione el scroll principal.
               Aquí no limitamos demasiado la altura para evitar dobles scroll incómodos. */
            overflow-y: visible;
        }

        .recibo-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--borde);
        }

        .recibo-item:last-child {
            border-bottom: none;
        }

        .recibo-item-nombre {
            flex: 1;
            color: var(--texto);
        }

        .recibo-item-cantidad {
            margin: 0 15px;
            color: var(--texto-claro);
        }

        .recibo-item-precio {
            font-weight: bold;
            color: var(--graphite);
            min-width: 100px;
            text-align: right;
        }

        .recibo-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 3px solid var(--primario);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recibo-total-label {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--graphite);
        }

        .recibo-total-monto {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primario);
        }

        .recibo-vacio {
            text-align: center;
            padding: 40px 20px;
            color: var(--texto-claro);
        }

        .btn-finalizar {
            width: 100%;
            background: var(--primario);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 6px 20px rgba(235, 148, 134, 0.4);
        }

        .btn-finalizar:hover:not(:disabled) {
            background: var(--dusty-olive);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(100, 111, 88, 0.5);
        }

        .btn-finalizar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .categoria-pedido {
            margin-bottom: 40px;
        }

        .categoria-pedido h3 {
            color: var(--graphite);
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--thistle);
        }

        @media (max-width: 1024px) {
            .pedido-container {
                grid-template-columns: 1fr;
            }

            .recibo-section {
                position: relative;
                top: 0;
            }
        }

        @media (max-width: 768px) {
            .productos-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        /* Mejoras para pantallas móviles pequeñas */
        @media (max-width: 480px) {
            .productos-grid { grid-template-columns: 1fr; gap: 12px; }
            .producto-card { display: flex; gap: 12px; align-items: stretch; }
            .producto-img { width: 40%; min-height: 90px; height: auto; background-size: cover; }
            .producto-info { padding: 10px; width: 60%; }
            .producto-info h4 { font-size: 0.95rem; }
            .bundle-controls { gap: 6px; }
            .bundle-select, .packages-input { font-size: 0.95rem; }
            .packages-input { width: 60%; margin: 0 auto; }
            /* Ajustes para que el recibo muestre correctamente y el botón no quede sobrepuesto */
            .recibo-section { max-height: calc(100vh - 120px); padding: 18px; }
            .recibo-content { max-height: calc(100vh - 220px); }
            /* Hacer que el botón sea sticky dentro de la sección en móviles */
            .recibo-section .btn-finalizar { position: sticky; bottom: 12px; z-index: 30; margin-top: 8px; }
            /* Añadir espacio inferior al contenido para evitar solapamiento con el botón */
            .recibo-content { padding-bottom: 80px; }
            /* Mejorar visibilidad del select overlay en pantallas pequeñas */
            .select-wrapper .select-display { right: 46px; left: 12px; }
        }

        #recibo-imagen {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <a href="index.html">
                <img src="img/logo.jpg" alt="Los Gustitos de Vicky's">
            </a>
        </div>
        <nav>
            <a href="index.html"><i class="fas fa-home"></i><span class="nav-text">Inicio</span></a>
            <a href="menu.html"><i class="fas fa-book-open"></i><span class="nav-text">Ver Menú</span></a>
            <a href="pedido.html"><i class="fas fa-shopping-cart"></i><span class="nav-text">Pedido</span></a>
            <a href="servicios.html"><i class="fas fa-concierge-bell"></i><span class="nav-text">Servicios</span></a>
        </nav>
    </header>

    <section class="hero">
        <h1>Realizar Pedido</h1>
        <p style="font-size: 1.3rem; color: white; margin-top: 10px;">Selecciona tus productos (mínimo 20 unidades por producto)</p>
    </section>

    <main>
        <div class="pedido-container">
            <div class="productos-section">
                <h2><i class="fas fa-utensils"></i> Selecciona tus productos</h2>
                
                <!-- Productos se cargarán aquí dinámicamente -->
                <div id="productos-container"></div>
            </div>

            <div class="recibo-section">
                <h2><i class="fas fa-receipt"></i> Resumen del Pedido</h2>
                <div class="recibo-content" id="recibo-content">
                    <div class="recibo-vacio">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; color: var(--thistle); margin-bottom: 15px;"></i>
                        <p>Selecciona productos para ver el resumen</p>
                    </div>
                </div>
                <button class="btn-finalizar" id="btn-finalizar" disabled>
                    <i class="fab fa-whatsapp"></i> Enviar Pedido por WhatsApp
                </button>
            </div>
        </div>
    </main>

    <div id="recibo-imagen"></div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3><i class="fas fa-clock"></i> Tiempo de Anticipación</h3>
                <p>¿Con cuánto tiempo pedir?</p>
                <p><strong>Mínimo 72 horas de anticipación</strong> para garantizar la mejor calidad en tu evento.</p>
            </div>
            
            <div class="footer-section">
                <h3><i class="fas fa-map-marker-alt"></i> Zonas de Reparto</h3>
                <p>Llevamos nuestros sabores a toda Arequipa:</p>
                <ul>
                    <li><i class="fas fa-check"></i> Centro Histórico</li>
                    <li><i class="fas fa-check"></i> Yanahuara</li>
                    <li><i class="fas fa-check"></i> Cayma</li>
                    <li><i class="fas fa-check"></i> Sachaca</li>
                    <li><i class="fas fa-check"></i> Y otros distritos</li>
                </ul>
                <p><em>Consulta disponibilidad para tu zona</em></p>
            </div>
            
            <div class="footer-section">
                <h3><i class="fas fa-money-bill-wave"></i> Formas de Pago</h3>
                <p>Aceptamos múltiples formas de pago:</p>
                <ul>
                    <li><i class="fab fa-whatsapp"></i> Yape</li>
                    <li><i class="fab fa-whatsapp"></i> Plin</li>
                    <li><i class="fas fa-university"></i> Transferencia Bancaria</li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3><i class="fab fa-whatsapp"></i> Contáctanos</h3>
                <p>¿Tienes dudas o quieres personalizar tu pedido?</p>
                <a href="https://wa.me/51933056666?text=Hola!%20Quiero%20más%20información" class="whatsapp-btn" target="_blank">
                    <i class="fab fa-whatsapp"></i> Escríbenos por WhatsApp
                </a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2026 Los Gustitos de Vicky's. Calidad hecha con amor.</p>
        </div>
    </footer>

    <script>
        // Base de datos de productos con precios por paquete (valores en soles)
        // Notas: bocaditos y similares se venden a partir de 20 unidades (tamaños: 20/50/100)
        // Platos de Fondo y Zona Kids: tamaños típicos 10/50 (se agrega 20 estimado = 10*2 - 35)
        const productos = [
            // Para Empezar (bocaditos)
            { id: 1, nombre: 'Ceviche en Conchitas', imagen: 'imagenes/bocaditos/ceviche-conchitas.jpg', bundles: {20:38, 50:95, 100:180}, categoria: 'Para Empezar', minUnits: 20 },
            { id: 2, nombre: 'Choritos a la Chalaca', imagen: 'imagenes/bocaditos/choritos.jpg', bundles: {20:36, 50:90, 100:170}, categoria: 'Para Empezar', minUnits: 20 },
            { id: 3, nombre: 'Mini Causitas de Pollo', imagen: 'imagenes/bocaditos/mini-causa-pollo.jpg', bundles: {20:34, 50:85, 100:160}, categoria: 'Para Empezar', minUnits: 20 },
            { id: 4, nombre: 'Mini Causitas de Atún', imagen: 'imagenes/bocaditos/mini-causa-atun.png', bundles: {20:30, 50:75, 100:145}, categoria: 'Para Empezar', minUnits: 20 },

            // Calentitos y Crujientes
            { id: 5, nombre: 'Tequeños', imagen: 'imagenes/bocaditos/tequeños.jpg', bundles: {20:28, 50:70, 100:130}, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 6, nombre: 'Wantán Frito', imagen: 'imagenes/bocaditos/wantanes.jpeg', bundles: {20:30, 50:75, 100:145}, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 7, nombre: 'Brochetas de Pollo', imagen: 'imagenes/bocaditos/brochetas.jpg', bundles: {20:40, 50:100, 100:190}, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 8, nombre: 'Muslitos de Pollo', imagen: 'imagenes/bocaditos/muslitos-pollo.jpg', bundles: {20:36, 50:90, 100:175}, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 9, nombre: 'Canastitas de Pollo', imagen: 'imagenes/bocaditos/canastitas-polllo.avif', bundles: null, comingSoon: true, categoria: 'Calentitos y Crujientes', minUnits: 20 },
            { id: 10, nombre: 'Mini Tamalitos', imagen: 'imagenes/bocaditos/minitamalitos.jpeg', bundles: {20:40, 50:100, 100:190}, categoria: 'Calentitos y Crujientes', minUnits: 20 },

            // Los Sanguchitos
            { id: 11, nombre: 'Petipanes con Pollo Deshilachado', imagen: 'imagenes/bocaditos/petipan.jpg', bundles: {50:90}, categoria: 'Los Sanguchitos', minUnits: 50 },
            { id: 12, nombre: 'Hamburguesitas Caseras', imagen: 'imagenes/bocaditos/hamburguesitas.jpg', bundles: {20:30, 50:80, 100:150}, categoria: 'Los Sanguchitos', minUnits: 20 },
            { id: 13, nombre: 'Mini Triples Clásicos', imagen: 'imagenes/bocaditos/minitriples.jpg', bundles: null, comingSoon: true, categoria: 'Los Sanguchitos', minUnits: 20 },
            { id: 14, nombre: 'Mini Triples Especial', imagen: 'imagenes/bocaditos/mini-triples.jpg', bundles: null, comingSoon: true, categoria: 'Los Sanguchitos', minUnits: 20 },

            // Platos de Fondo (tamaños 10 / 20 (estimado) / 50)
            // 20 = 10*2 - 35 (estimación solicitada)
            { id: 15, nombre: 'Asado con Puré', imagen: 'imagenes/platos/asado-pure.jpeg', bundles: {10:180, 20: (180*2 - 35), 50:830}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 16, nombre: 'Ají de Gallina', imagen: 'imagenes/platos/aji-gallina.jpg', bundles: {10:100, 20: (100*2 - 35), 50:460}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 17, nombre: 'Chancho al Horno', imagen: 'imagenes/platos/chancho-horno.avif', bundles: {10:200, 20: (200*2 - 35), 50:950}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 18, nombre: 'Pollo al Horno', imagen: 'imagenes/platos/pollo-horno.jpg', bundles: {10:160, 20: (160*2 - 35), 50:760}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 19, nombre: 'Chuleta Completa', imagen: 'imagenes/platos/chuleta-completo.jpg', bundles: {10:190, 20: (190*2 - 35), 50:920}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 20, nombre: 'Pastel de Papa Premium', imagen: 'imagenes/platos/pastel-papa-premium.png', bundles: {10:200, 20: (200*2 - 35), 50:950}, categoria: 'Platos de Fondo', minUnits: 10 },
            { id: 21, nombre: 'Pastel de Tallarín Premium', imagen: 'imagenes/platos/pastel-tallarin-milanesa.png', bundles: {10:200, 20: (200*2 - 35), 50:950}, categoria: 'Platos de Fondo', minUnits: 10 },

            // Zona Kids (tamaños 10 / 20 estimado / 50)
            { id: 22, nombre: 'Milanesa de Pollo', imagen: 'imagenes/platos/milanesa-pollo.jpg', bundles: {10:110, 20: (110*2 - 35), 50:500}, categoria: 'Zona Kids', minUnits: 10 },
            { id: 23, nombre: 'Chicharrón de Pollo', imagen: 'imagenes/platos/chicharron-pollo.jpg', bundles: {10:110, 20: (110*2 - 35), 50:500}, categoria: 'Zona Kids', minUnits: 10 },
            { id: 24, nombre: 'Arroz Chaufa', imagen: 'imagenes/platos/chaufa.avif', bundles: {10:95, 20: (95*2 - 35), 50:450}, categoria: 'Zona Kids', minUnits: 10 }
        ];

        // Estado del pedido
        const pedido = {};
        const DISCOUNT_PERCENT = 0.05; // 5% descuento al seleccionar 50 unidades (Platos / Kids)

        // Renderizar productos (ahora con selección de paquetes o elección por unidades)
        function renderizarProductos() {
            const container = document.getElementById('productos-container');
            container.innerHTML = '';
            const categorias = [...new Set(productos.map(p => p.categoria))];

            const categoryIcons = {
                'Para Empezar': 'fa-snowflake',
                'Calentitos y Crujientes': 'fa-fire',
                'Los Sanguchitos': 'fa-bread-slice',
                'Platos de Fondo': 'fa-utensils',
                'Zona Kids': 'fa-child'
            };

            categorias.forEach(categoria => {
                const categoriaDiv = document.createElement('div');
                categoriaDiv.className = 'categoria-pedido';
                const iconClass = categoryIcons[categoria] || 'fa-utensils';
                categoriaDiv.innerHTML = `<h3><i class="fas ${iconClass}" style="margin-right:8px;"></i>${categoria}</h3><div class="productos-grid"></div>`;

                const grid = categoriaDiv.querySelector('.productos-grid');
                const productosCategoria = productos.filter(p => p.categoria === categoria);

                productosCategoria.forEach(producto => {
                    const card = document.createElement('div');
                    card.className = 'producto-card';
                    card.dataset.productoId = producto.id;

                    const minUnits = producto.minUnits || 20;

                    // Si el producto está marcado como próximamente (comingSoon) o no tiene bundles
                    if (producto.comingSoon || !producto.bundles) {
                        card.innerHTML = `
                            <div class="producto-img" style="background-image: url('${producto.imagen}')"></div>
                            <div class="producto-info">
                                <h4>${producto.nombre}</h4>
                                <div class="bundle-controls">
                                    <div class="coming-soon">Pronto</div>
                                    <div class="small-note">Disponibilidad y precio próximamente</div>
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                        return;
                    }
                    // Si el producto tiene minUnits >= 20 lo tratamos como bocadito (select con paquetes)
                    if ((producto.minUnits || 20) >= 20) {
                        // mostrar opciones desde 20 hasta 100 (step 10) para bocaditos
                        const sizes = [20,30,40,50,60,70,80,90,100];
                        let optionsHtml = '<option value="">Seleccionar paquete</option>';
                        // regla: precio20 está en producto.bundles[20]; cada +10 añade la mitad de precio20
                        const price20 = producto.bundles && producto.bundles[20] !== undefined ? Number(producto.bundles[20]) : null;

                        sizes.forEach(size => {
                            let displayPrice;
                            if (producto.bundles && producto.bundles[size] !== undefined) {
                                displayPrice = Number(producto.bundles[size]);
                            } else if (price20 !== null) {
                                const increments = (size - 20) / 10; // 0 for 20, 1 for 30, ...
                                const half = price20 / 2;
                                displayPrice = price20 + increments * half;
                            } else {
                                // fallback: proporcional por unidad (si no hay price20)
                                const perUnit = producto.bundles && producto.bundles[50] !== undefined ? Number(producto.bundles[50]) / 50 : (producto.bundles && producto.bundles[100] !== undefined ? Number(producto.bundles[100]) / 100 : 0);
                                displayPrice = perUnit * size;
                            }
                            // descuento fijo S/10 para 100 unidades SOLO si no existe un precio explícito para 100
                            if (size === 100 && !(producto.bundles && producto.bundles[size] !== undefined)) displayPrice = Math.max(0, displayPrice - 10);
                            optionsHtml += `<option value="${size}">${size} unidades — S/ ${displayPrice.toFixed(2)}</option>`;
                        });

                        card.innerHTML = `
                            <div class="producto-img" style="background-image: url('${producto.imagen}')"></div>
                            <div class="producto-info">
                                <h4>${producto.nombre}</h4>
                                <div class="bundle-controls">
                                    <label>Paquete:</label>
                                    <select class="bundle-select" data-producto-id="${producto.id}">${optionsHtml}</select>
                                    <div class="small-note">Mínimo ${minUnits} unidades por producto</div>
                                    <div class="error-mensaje">Cantidad mínima no alcanzada</div>
                                </div>
                            </div>
                        `;

                        grid.appendChild(card);
                    } else {
                        // Platos de Fondo / Zona Kids: usar select como bocaditos (10/20/30/40/50 + 'other')
                        const pricePer10 = Number(producto.bundles[10]);
                        // construimos opciones para 10,20,30,40,50
                        const sizes = [10,20,30,40,50];
                        let optionsHtml = '<option value="">Seleccionar paquete/cantidad</option>';
                        sizes.forEach(sz => {
                            // usar precio definido en bundles si existe, si no calcular como pricePer10 * multiplier
                            let displayPrice = producto.bundles[sz] !== undefined ? Number(producto.bundles[sz]) : pricePer10 * (sz/10);
                            // si no hay bundle definido para 50 y existe descuento, aplicar descuento
                            if (sz === 50 && producto.bundles[50] === undefined) {
                                displayPrice = displayPrice * (1 - DISCOUNT_PERCENT);
                            }
                            optionsHtml += `<option value="${sz}">${sz} unidades — S/ ${displayPrice.toFixed(2)}</option>`;
                        });
                        optionsHtml += `<option value="other">Sugerir otra cantidad</option>`;

                        card.innerHTML = `
                            <div class="producto-img" style="background-image: url('${producto.imagen}')"></div>
                            <div class="producto-info">
                                <h4>${producto.nombre}</h4>
                                <div class="bundle-controls">
                                    <label>Paquete / cantidad:</label>
                                    <select class="bundle-select" data-producto-id="${producto.id}">${optionsHtml}</select>
                                    <input type="number" min="10" class="custom-qty" placeholder="Indica cantidad (>=10)" style="width:140px; margin-top:6px; display:none;">
                                    <div class="small-note" style="margin-top:6px;">Precio base por 10 unidades: S/ ${pricePer10.toFixed(2)}</div>
                                    <div class="error-mensaje">Cantidad mínima no alcanzada</div>
                                </div>
                            </div>
                        `;

                        grid.appendChild(card);
                    }
                });

                container.appendChild(categoriaDiv);
            });

            // Listener para selects (selección de paquete implica 1 paquete)
            document.querySelectorAll('.bundle-select').forEach(sel => sel.addEventListener('change', manejarCambioPaquete));

            // Mejorar selects: envolver con display para animar el texto si es largo
            function enhanceSelects(){
                document.querySelectorAll('.bundle-select').forEach(sel => {
                    // evitar envolver múltiples veces
                    if (sel.closest('.select-wrapper')) return;
                    const wrapper = document.createElement('div'); wrapper.className = 'select-wrapper';
                    const display = document.createElement('span'); display.className = 'select-display';
                    const marquee = document.createElement('span'); marquee.className = 'marquee';
                    marquee.textContent = (sel.options[sel.selectedIndex] || sel.options[0]).text;
                    display.appendChild(marquee);
                    // insertar wrapper
                    sel.parentNode.insertBefore(wrapper, sel);
                    wrapper.appendChild(sel);
                    wrapper.appendChild(display);
                    // permitir que el dropdown sobresalga
                    wrapper.style.overflow = 'visible';
                    // iniciar con overlay activo (controla visibilidad con clase)
                    wrapper.classList.add('overlay-active');
                    // permitir clics en el select (display no captura eventos)
                    display.style.pointerEvents = 'none';

                    function updateMarquee(){
                        const text = (sel.options[sel.selectedIndex] || sel.options[0]).text;
                        marquee.textContent = text;
                        // pequeña espera para que el DOM calcule tamaños
                        requestAnimationFrame(() => {
                            const cw = display.clientWidth;
                            const sw = marquee.scrollWidth;
                            if (sw > cw) {
                                const shift = sw - cw;
                                marquee.style.setProperty('--shift', `${shift}px`);
                                display.classList.add('scrolling');
                            } else {
                                display.classList.remove('scrolling');
                                marquee.style.removeProperty('--shift');
                                marquee.style.transform = 'translateX(0)';
                            }
                        });
                    }

                    sel.addEventListener('change', () => {
                        updateMarquee();
                        // si seleccionó 'other' mostramos el input si existe
                        const card = sel.closest('.producto-card');
                        if (!card) return;
                        const custom = card.querySelector('.custom-qty');
                        if (sel.value === 'other') {
                            if (custom) {
                                custom.style.display = 'inline-block';
                                // attach marquee-only handler without replacing existing handlers
                                if (custom._marqueeHandler) custom.removeEventListener('input', custom._marqueeHandler);
                                custom._marqueeHandler = function(){
                                    marquee.textContent = `${custom.value || ''} unidades`;
                                    updateMarquee();
                                };
                                custom.addEventListener('input', custom._marqueeHandler);
                                if (custom.value) custom._marqueeHandler();
                            }
                        } else {
                            if (custom) {
                                custom.style.display = 'none';
                                // remove only marquee handler, keep other handlers (e.g., pedido logic)
                                if (custom._marqueeHandler) { custom.removeEventListener('input', custom._marqueeHandler); delete custom._marqueeHandler; }
                                custom.value = '';
                            }
                        }
                    });

                    // controlar overlay mediante la clase en el wrapper para mayor compatibilidad
                    const wrapperNode = wrapper;
                    sel.addEventListener('focus', () => { if (wrapperNode) wrapperNode.classList.remove('overlay-active'); updateMarquee(); });
                    sel.addEventListener('blur', () => { if (wrapperNode) wrapperNode.classList.add('overlay-active'); updateMarquee(); });
                    sel.addEventListener('pointerdown', () => { if (wrapperNode) wrapperNode.classList.remove('overlay-active'); });
                    sel.addEventListener('mousedown', () => { if (wrapperNode) wrapperNode.classList.remove('overlay-active'); });
                    sel.addEventListener('keydown', (ev) => { if (ev.key === ' ' || ev.key === 'ArrowDown' || ev.key === 'Enter') { if (wrapperNode) wrapperNode.classList.remove('overlay-active'); } });

                    // init
                    updateMarquee();
                });
            }

            enhanceSelects();
        }

        // Manejar cambios en cantidad para Platos / Zona Kids
        function manejarCambioCantidad(productoId) {
            const producto = productos.find(p => p.id === productoId);
            const card = document.querySelector(`.producto-card[data-producto-id="${productoId}"]`);
            if (!card) return;

            const radios = card.querySelectorAll(`input[name="qty-${productoId}"]`);
            const customInput = card.querySelector('.custom-qty');
            const errorMensaje = card.querySelector('.error-mensaje');

            let selected = Array.from(radios).find(r => r.checked);
            // si el usuario escribió en el input personalizado sin marcar 'other', lo activamos
            if (!selected && customInput && customInput.value) {
                const otherRadio = Array.from(radios).find(r => r.value === 'other');
                if (otherRadio) {
                    otherRadio.checked = true;
                    selected = otherRadio;
                }
            }
            if (!selected) {
                // nothing selected -> remove
                delete pedido[productoId];
                card.classList.remove('selected');
                errorMensaje.classList.remove('show');
                if (customInput) customInput.style.display = 'none';
                actualizarRecibo();
                return;
            }

            // mostrar/ocultar campo personalizado
            if (customInput) customInput.style.display = (selected.value === 'other') ? 'inline-block' : 'none';

            let qty;
            if (selected.value === 'other') {
                qty = parseInt(customInput ? customInput.value : NaN, 10);
            } else {
                qty = parseInt(selected.value, 10);
            }

            if (isNaN(qty) || qty < (producto.minUnits || 10)) {
                errorMensaje.classList.add('show');
                delete pedido[productoId];
                card.classList.remove('selected');
                actualizarRecibo();
                return;
            }

            errorMensaje.classList.remove('show');

            // Price logic: base price is bundles[10]
            const pricePer10 = Number(producto.bundles[10]);
            const multiplier = qty / 10;
            let subtotal = pricePer10 * multiplier;

            // Aplicar descuento pequeño si qty == 50
            if (qty === 50) subtotal = subtotal * (1 - DISCOUNT_PERCENT);

            pedido[productoId] = { type: 'units', qty, pricePer10, subtotal, totalUnits: qty };
            card.classList.add('selected');
            actualizarRecibo();
        }

        // Manejar cambios en paquetes (select o número de paquetes / cantidades)
        function manejarCambioPaquete(e) {
            const productoId = parseInt(e.target.dataset.productoId);
            const card = document.querySelector(`.producto-card[data-producto-id="${productoId}"]`);
            const select = card.querySelector('.bundle-select');
            const errorMensaje = card.querySelector('.error-mensaje');
            const producto = productos.find(p => p.id === productoId);
            const minUnits = producto.minUnits || 10;

            const val = select.value;

            // Sin selección
            if (!val) {
                delete pedido[productoId];
                card.classList.remove('selected');
                errorMensaje.classList.remove('show');
                const custom = card.querySelector('.custom-qty'); if (custom) { custom.style.display = 'none'; custom.value = ''; custom.oninput = null; }
                actualizarRecibo();
                return;
            }

            // Opción 'other' -> mostrar input custom y calcular proporcional
            if (val === 'other') {
                const custom = card.querySelector('.custom-qty');
                if (!custom) return;
                custom.style.display = 'inline-block';
                // reemplazar handler para evitar acumulación
                custom.oninput = function () {
                    const qty = parseInt(custom.value, 10);
                    if (isNaN(qty) || qty < minUnits) {
                        errorMensaje.classList.add('show');
                        delete pedido[productoId];
                        card.classList.remove('selected');
                        actualizarRecibo();
                        return;
                    }
                    errorMensaje.classList.remove('show');
                    const pricePer10 = Number(producto.bundles[10]);
                    let subtotal = pricePer10 * (qty / 10);
                    if (qty === 50) subtotal = subtotal * (1 - DISCOUNT_PERCENT);
                    pedido[productoId] = { type: 'units', qty, pricePer10, subtotal, totalUnits: qty };
                    card.classList.add('selected');
                    actualizarRecibo();
                };

                // si ya tiene valor previo, disparar cálculo
                if (custom.value) custom.oninput();
                return;
            }

            // Valores numéricos (paquetes para bocaditos o cantidades para platos)
            const bundleSize = parseInt(val, 10);
            // Calcular precio usando bundle si existe;
            // Para bocaditos (minUnits >= 20) aplicar regla: precio20 + (n * (precio20/2)) por cada +10
            let priceForSize;
            if (producto.bundles && producto.bundles[bundleSize] !== undefined) {
                priceForSize = Number(producto.bundles[bundleSize]);
            } else if ((producto.minUnits || 20) >= 20 && producto.bundles && producto.bundles[20] !== undefined) {
                // bocaditos: usar precio base en 20 y sumar la mitad de ese precio por cada paso de 10
                const price20 = Number(producto.bundles[20]);
                const increments = (bundleSize - 20) / 10; // 0 para 20, 1 para 30, ...
                const half = price20 / 2;
                priceForSize = price20 + increments * half;
            } else {
                // fallback: proporcional por unidad tomando referencias en orden
                let pricePerUnit = 0;
                if (producto.bundles && producto.bundles[20] !== undefined) pricePerUnit = Number(producto.bundles[20]) / 20;
                else if (producto.bundles && producto.bundles[50] !== undefined) pricePerUnit = Number(producto.bundles[50]) / 50;
                else if (producto.bundles && producto.bundles[100] !== undefined) pricePerUnit = Number(producto.bundles[100]) / 100;
                else if (producto.bundles && producto.bundles[10] !== undefined) pricePerUnit = Number(producto.bundles[10]) / 10;
                priceForSize = pricePerUnit * bundleSize;
            }
            // descuento fijo para 100 unidades (solo bocaditos según requerimiento)
            // Aplicar descuento sólo si no hay un precio explícito definido en producto.bundles[100]
            if (bundleSize === 100 && !(producto.bundles && producto.bundles[bundleSize] !== undefined)) priceForSize = Math.max(0, priceForSize - 10);

            const packages = 1;
            const totalUnits = bundleSize * packages;

            if (totalUnits < minUnits) {
                errorMensaje.classList.add('show');
                delete pedido[productoId];
                card.classList.remove('selected');
            } else {
                errorMensaje.classList.remove('show');
                pedido[productoId] = { type: 'bundle', bundleSize, packages, bundlePrice: priceForSize, totalUnits };
                card.classList.add('selected');
                // ocultar custom si estaba visible
                const custom = card.querySelector('.custom-qty'); if (custom) { custom.style.display = 'none'; custom.value = ''; custom.oninput = null; }
            }

            actualizarRecibo();
        }

        // Actualizar recibo
        function actualizarRecibo() {
            const reciboContent = document.getElementById('recibo-content');
            const btnFinalizar = document.getElementById('btn-finalizar');
            const items = Object.keys(pedido);

            if (items.length === 0) {
                reciboContent.innerHTML = `
                    <div class="recibo-vacio">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; color: var(--thistle); margin-bottom: 15px;"></i>
                        <p>Selecciona productos para ver el resumen</p>
                    </div>
                `;
                btnFinalizar.disabled = true;
                return;
            }

            let total = 0;
            const fecha = new Date();
            const fechaFormateada = fecha.toLocaleDateString('es-PE', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let html = `
                <div class="recibo-header">
                    <h3>Los Gustitos de Vicky's</h3>
                    <p style="margin: 5px 0; color: var(--texto-claro); font-size: 0.9rem;">Pedido #${Date.now().toString().slice(-6)}</p>
                    <p style="margin: 5px 0; color: var(--texto-claro); font-size: 0.85rem;">${fechaFormateada}</p>
                </div>
                <div class="recibo-items">
            `;

            items.forEach(productoId => {
                const producto = productos.find(p => p.id === parseInt(productoId));
                const entry = pedido[productoId];
                let subtotal = 0;

                if (entry.type === 'units') {
                    subtotal = Number(entry.subtotal || entry.pricePer10 * (entry.qty / 10));
                    total += subtotal;

                    html += `
                        <div class="recibo-item">
                            <div class="recibo-item-nombre">
                                ${producto.nombre}<br>
                                <small style="color: var(--texto-claro); font-size: 0.85rem;">${entry.qty} unidades — S/ ${entry.pricePer10.toFixed(2)} por 10 u. ${entry.qty===50? '(incluye descuento)':''}</small>
                            </div>
                            <div class="recibo-item-cantidad">${entry.qty} u.</div>
                            <div class="recibo-item-precio">S/ ${subtotal.toFixed(2)}</div>
                            <div style="margin-left:12px;"><button class="remove-item" data-producto-id="${producto.id}" style="background:transparent;border:1px solid var(--borde);padding:6px 10px;border-radius:8px;cursor:pointer;color:var(--graphite);">Quitar</button></div>
                        </div>
                    `;
                } else {
                    // paquete (bocaditos u otros)
                    subtotal = entry.bundlePrice * entry.packages;
                    total += subtotal;

                    html += `
                        <div class="recibo-item">
                            <div class="recibo-item-nombre">
                                ${producto.nombre}<br>
                                <small style="color: var(--texto-claro); font-size: 0.85rem;">${entry.packages} x ${entry.bundleSize} unidades — S/ ${entry.bundlePrice.toFixed(2)} por paquete</small>
                            </div>
                            <div class="recibo-item-cantidad">${entry.totalUnits} u.</div>
                            <div class="recibo-item-precio">S/ ${subtotal.toFixed(2)}</div>
                            <div style="margin-left:12px;"><button class="remove-item" data-producto-id="${producto.id}" style="background:transparent;border:1px solid var(--borde);padding:6px 10px;border-radius:8px;cursor:pointer;color:var(--graphite);">Quitar</button></div>
                        </div>
                    `;
                }
            });

            html += `
                </div>
                <div class="recibo-total">
                    <div class="recibo-total-label">Total:</div>
                    <div class="recibo-total-monto">S/ ${total.toFixed(2)}</div>
                </div>
            `;

            reciboContent.innerHTML = html;
                // Adjuntar listeners a botones Quitar
                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.addEventListener('click', (ev) => {
                        const id = parseInt(ev.currentTarget.dataset.productoId);
                        // remover del pedido y resetear controles
                        delete pedido[id];
                        const card = document.querySelector(`.producto-card[data-producto-id="${id}"]`);
                        if (card) {
                            const sel = card.querySelector('.bundle-select');
                            if (sel) sel.value = '';
                            const radios = card.querySelectorAll(`input[name="qty-${id}"]`);
                            radios.forEach(r => r.checked = false);
                            const custom = card.querySelector('.custom-qty');
                            if (custom) { custom.value = ''; custom.style.display = 'none'; custom.oninput = null; }
                            card.classList.remove('selected');
                        }
                        actualizarRecibo();
                    });
                });
            btnFinalizar.disabled = false;
        }

        // Generar imagen del recibo y redirigir a WhatsApp
        async function finalizarPedido() {
            const btnFinalizar = document.getElementById('btn-finalizar');
            const reciboContent = document.getElementById('recibo-content');
            const reciboImagen = document.getElementById('recibo-imagen');
            
            // Deshabilitar botón y mostrar loading
            btnFinalizar.disabled = true;
            const textoOriginal = btnFinalizar.innerHTML;
            btnFinalizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando recibo...';
            
            // Crear una copia del recibo para la imagen con mejor formato
            reciboImagen.innerHTML = reciboContent.innerHTML;
            reciboImagen.style.display = 'block';
            reciboImagen.style.background = 'white';
            reciboImagen.style.padding = '40px';
            reciboImagen.style.maxWidth = '600px';
            reciboImagen.style.margin = '0 auto';
            reciboImagen.style.borderRadius = '20px';
            reciboImagen.style.boxShadow = '0 4px 15px rgba(49, 47, 47, 0.1)';
            reciboImagen.style.position = 'absolute';
            reciboImagen.style.left = '-9999px';

            try {
                // Esperar un momento para que se renderice
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Generar imagen usando html2canvas
                const canvas = await html2canvas(reciboImagen, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });

                // Convertir canvas a blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        throw new Error('Error al generar la imagen');
                    }
                    
                    // Crear URL temporal para la imagen
                    const imageUrl = URL.createObjectURL(blob);
                    
                    // Crear mensaje para WhatsApp con datos de productos (soportando packages y unidades)
                    const items = Object.keys(pedido);
                    let mensaje = '¡Hola! 👋\n\n';
                    mensaje += 'Quiero realizar el siguiente pedido:\n\n';

                    let total = 0;
                    items.forEach(productoId => {
                        const producto = productos.find(p => p.id === parseInt(productoId));
                        const entry = pedido[productoId];
                        if (entry.type === 'units') {
                            const sub = Number(entry.subtotal || entry.pricePer10 * (entry.qty / 10));
                            total += sub;
                            mensaje += `• ${producto.nombre}: ${entry.qty} unidades — S/ ${sub.toFixed(2)}\n`;
                        } else {
                            const sub = entry.bundlePrice * entry.packages;
                            total += sub;
                            mensaje += `• ${producto.nombre}: ${entry.totalUnits} unidades (${entry.packages} x ${entry.bundleSize}) — S/ ${sub.toFixed(2)}\n`;
                        }
                    });

                    mensaje += `\n💰 Total: S/ ${total.toFixed(2)}\n\n`;
                    mensaje += '📎 Adjunto el recibo del pedido en la siguiente imagen.';
                    
                    // Codificar mensaje para URL
                    const mensajeCodificado = encodeURIComponent(mensaje);
                    
                    // Crear enlace de WhatsApp
                    const whatsappUrl = `https://wa.me/51933056666?text=${mensajeCodificado}`;
                    
                    // Crear enlace de descarga para la imagen
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = `pedido-vickys-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Mostrar mensaje informativo
                    alert('✅ Recibo descargado exitosamente.\n\nAhora se abrirá WhatsApp. Por favor:\n1. Adjunta la imagen del recibo que se descargó\n2. Envía el mensaje');
                    
                    // Redirigir a WhatsApp después de un breve delay
                    setTimeout(() => {
                        window.open(whatsappUrl, '_blank');
                        
                        // Limpiar después de un momento
                        setTimeout(() => {
                            URL.revokeObjectURL(imageUrl);
                            reciboImagen.style.display = 'none';
                            reciboImagen.innerHTML = '';
                            reciboImagen.style.position = 'static';
                            btnFinalizar.innerHTML = textoOriginal;
                            btnFinalizar.disabled = false;
                        }, 2000);
                    }, 1000);
                }, 'image/png', 0.95);
            } catch (error) {
                console.error('Error al generar imagen:', error);
                alert('❌ Hubo un error al generar el recibo. Por favor, intenta nuevamente.');
                btnFinalizar.innerHTML = textoOriginal;
                btnFinalizar.disabled = false;
                reciboImagen.style.display = 'none';
                reciboImagen.innerHTML = '';
                reciboImagen.style.position = 'static';
            }
        }

        // Event listener para botón finalizar
        document.getElementById('btn-finalizar').addEventListener('click', finalizarPedido);

        // Inicializar
        renderizarProductos();
    </script>
</body>
</html>
